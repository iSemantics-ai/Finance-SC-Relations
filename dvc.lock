schema: '2.0'
stages:
  load_data:
    cmd: python src/stages/load_data.py --config params.yaml
    deps:
    - path: src/stages/load_data.py
      hash: md5
      md5: e989dff0d73d1f4ec3c8ddaddc16206f
      size: 3717
    params:
      params.yaml:
        base.nlp: en_core_web_trf
        load_data:
          dataset: data/raw/llm_aligned_0_1_huge_complex.json
          entity_1: entity_1
          entity_2: entity_2
          output_dir: data/raw/relations_training_data.json
          target: relation
          text_col: sentence
    outs:
    - path: data/raw/relations_training_data.json
      hash: md5
      md5: 34a13f21603a9294d5b4e1cc563f15a4
      size: 19426710
  data_split:
    cmd: python src/stages/data_split.py --config params.yaml
    deps:
    - path: data/raw/relations_training_data.json
      hash: md5
      md5: 34a13f21603a9294d5b4e1cc563f15a4
      size: 19426710
    - path: src/stages/data_split.py
      hash: md5
      md5: eaaee750b9a1ab93832bc51b998dabe6
      size: 4283
    - path: src/utils/preprocess.py
      hash: md5
      md5: cb6003a19e3fbf04de38cae3781735b6
      size: 18630
    params:
      params.yaml:
        base:
          basic_columns:
          - Label
          - concept_class
          - idx
          - org_groups
          - spans
          entity_static_position: false
          index_col: idx
          log_level: INFO
          main_relations:
          - supplier
          - customer
          nlp: en_core_web_trf
          random_state: 42
        data_split:
          drop_issues: false
          issues_name: LLM_ALL_ALIGNED_COMPLEX
          issues_pruning: 0.3
          neg_supply: true
          num_positions: 0
          output_dir: data/train/
          random_choice: true
          stratify_by:
          - concept_class
          - Label
          val_size: 0.2
        load_data.output_dir: data/raw/relations_training_data.json
    outs:
    - path: data/train/distributions.md
      hash: md5
      md5: ac268642edc40f302e5e05bc87a50473
      size: 1649
    - path: data/train/train.json
      hash: md5
      md5: 912ecfd64c219775e4dc22ec59f5c8e8
      size: 19029316
    - path: data/train/valid.json
      hash: md5
      md5: 29eefcd06165d02995d8e68a87bc025d
      size: 4968687
  train_preprocess:
    cmd: python src/stages/train_preprocess.py --config params.yaml
    deps:
    - path: data/train/train.json
      hash: md5
      md5: 912ecfd64c219775e4dc22ec59f5c8e8
      size: 19029316
    - path: data/train/valid.json
      hash: md5
      md5: 29eefcd06165d02995d8e68a87bc025d
      size: 4968687
    - path: src/stages/train_preprocess.py
      hash: md5
      md5: 0a76dfec6cc5743c5f22a30cfd386f72
      size: 1334
    params:
      params.yaml:
        base:
          basic_columns:
          - Label
          - concept_class
          - idx
          - org_groups
          - spans
          entity_static_position: false
          index_col: idx
          log_level: INFO
          main_relations:
          - supplier
          - customer
          nlp: en_core_web_trf
          random_state: 42
        train_preprocess:
          inverse: true
          output_dir: data/train/
          relations_mapper: data/train/relations.pkl
          stage: train
    outs:
    - path: data/train/df_train.json
      hash: md5
      md5: 1132fdd9c416eee9c6e42d632235aef4
      size: 27418011
    - path: data/train/df_valid.json
      hash: md5
      md5: a749e9509e0eff3df0e649c623102227
      size: 7030365
    - path: data/train/relations.pkl
      hash: md5
      md5: cf2bcd4330b41de7fb87bfa290c016c3
      size: 177
  train:
    cmd: python src/stages/train.py --config params.yaml
    deps:
    - path: data/train/df_train.json
      hash: md5
      md5: 1132fdd9c416eee9c6e42d632235aef4
      size: 27418011
    - path: data/train/df_valid.json
      hash: md5
      md5: a749e9509e0eff3df0e649c623102227
      size: 7030365
    - path: data/train/relations.pkl
      hash: md5
      md5: cf2bcd4330b41de7fb87bfa290c016c3
      size: 177
    - path: src/relation_extraction/trainer.py
      hash: md5
      md5: 052ec5faed647dd8052338f45b8353ab
      size: 11933
    - path: src/stages/train.py
      hash: md5
      md5: b5462ff809c81328697268726deafd4e
      size: 955
    params:
      params.yaml:
        base:
          basic_columns:
          - Label
          - concept_class
          - idx
          - org_groups
          - spans
          entity_static_position: false
          index_col: idx
          log_level: INFO
          main_relations:
          - supplier
          - customer
          nlp: en_core_web_trf
          random_state: 42
        train:
          batch_size: 40
          fp16: 1
          freeze: 0
          gradient_acc_steps: 1
          lr: 2e-05
          max_norm: 1
          model_path: artifacts/re_model
          model_size: nlpaueb/sec-bert-num
          mutate_test: true
          mutate_train: true
          num_epochs: 2
          overwrite: false
          relations_mapper: data/train/relations.pkl
          reload: false
          train_data: data/train/df_train.json
          update_ext: false
          use_pretrained_blanks: 0
          valid_data: data/train/df_valid.json
          weight_decay: 0.0001
          weight_loss: false
    outs:
    - path: artifacts/re_model
      hash: md5
      md5: b9906ba25ee74a534b589d3ebc275e78.dir
      size: 437368329
      nfiles: 7
    - path: metrics/customer_f1_score.csv
      hash: md5
      md5: e0e54aa20a1e666337b40d3b5d30277f
      size: 41
    - path: metrics/other_f1_score.csv
      hash: md5
      md5: 30524eaadc6d640af721723ec4a26de0
      size: 39
    - path: metrics/supplier_f1_score.csv
      hash: md5
      md5: d589f5e94b31edb6ed48599f5ab1e1b5
      size: 42
    - path: metrics/train_accuracy.csv
      hash: md5
      md5: 54e999433f70946aca69babb1dbdd285
      size: 63
    - path: metrics/train_losses.csv
      hash: md5
      md5: 45d67e6b76a572e48e1dc941269d38ec
      size: 62
    - path: metrics/valid_accuracy.csv
      hash: md5
      md5: 0019617fe76d84c1fa4b0b6b74ccd732
      size: 38
    - path: metrics/valid_f1_macro.csv
      hash: md5
      md5: 1f4bf7dd3c9e26018c2d4fac40c70014
      size: 39
    - path: metrics/valid_precision.csv
      hash: md5
      md5: 5e1c09df4a5b13be717650a6ccbd0443
      size: 40
    - path: metrics/valid_recall.csv
      hash: md5
      md5: dd09379ea31f62d60741090c866e52f4
      size: 37
    - path: metrics/valid_roc_auc.png
      hash: md5
      md5: c97fb3d96f6171d5b20e778262d83f4d
      size: 63406
  evaluate:
    cmd: python src/stages/evaluate.py --config params.yaml
    deps:
    - path: artifacts/re_model
      hash: md5
      md5: b9906ba25ee74a534b589d3ebc275e78.dir
      size: 437368329
      nfiles: 7
    - path: src/relation_extraction/infer.py
      hash: md5
      md5: 27bff04f84d89cd41d25505eb979fb30
      size: 21308
    - path: src/stages/evaluate.py
      hash: md5
      md5: 08bd2e497ad9352ca6f93354269e38a5
      size: 9227
    params:
      params.yaml:
        base:
          basic_columns:
          - Label
          - concept_class
          - idx
          - org_groups
          - spans
          entity_static_position: false
          index_col: idx
          log_level: INFO
          main_relations:
          - supplier
          - customer
          nlp: en_core_web_trf
          random_state: 42
        train:
          batch_size: 40
          fp16: 1
          freeze: 0
          gradient_acc_steps: 1
          lr: 2e-05
          max_norm: 1
          model_path: artifacts/re_model
          model_size: nlpaueb/sec-bert-num
          mutate_test: true
          mutate_train: true
          num_epochs: 2
          overwrite: false
          relations_mapper: data/train/relations.pkl
          reload: false
          train_data: data/train/df_train.json
          update_ext: false
          use_pretrained_blanks: 0
          valid_data: data/train/df_valid.json
          weight_decay: 0.0001
          weight_loss: false
    outs:
    - path: metrics/dev_classification_report.md
      hash: md5
      md5: d7135f34cc76ea7d87d90af5e222f9aa
      size: 593
    - path: metrics/dev_confusion.png
      hash: md5
      md5: 095c8f37bc8870ee485984e41a12ad22
      size: 22363
    - path: metrics/dev_errors.xlsx
      hash: md5
      md5: f173273a23592bdff84edb2f15665549
      size: 142547
    - path: metrics/dev_inconsistent_directions.xlsx
      hash: md5
      md5: 6fc909713df232a07c3f0d6a9187368e
      size: 25982
    - path: metrics/dev_metrics.json
      hash: md5
      md5: bf418552f57ff9a9ffe50ce68145d3c8
      size: 114
    - path: metrics/test_classification_report.md
      hash: md5
      md5: 7d73676f0d71e4a69e2296a5883876cd
      size: 581
    - path: metrics/test_confusion.png
      hash: md5
      md5: 6117d90b150dff1f48c24d43f6a83970
      size: 26051
    - path: metrics/test_errors.xlsx
      hash: md5
      md5: ef3b57c36d2d3f1a399461bf8c4538e9
      size: 33068
    - path: metrics/test_inconsistent_directions.xlsx
      hash: md5
      md5: e1b7842feae3c7347e58817ed2e88216
      size: 11213
    - path: metrics/test_metrics.json
      hash: md5
      md5: 7bf2686ce8a831d4ecd9e7a66de87b99
      size: 117
  train_sc:
    cmd: python src/stages/sc_train.py
    deps:
    - path: data/train/train.json
      hash: md5
      md5: 912ecfd64c219775e4dc22ec59f5c8e8
      size: 19029316
    - path: data/train/valid.json
      hash: md5
      md5: 29eefcd06165d02995d8e68a87bc025d
      size: 4968687
    - path: src/sc_classifier/trainer.py
      hash: md5
      md5: 73baac91ab629abc6de60c2fad0524a6
      size: 28071
    - path: src/stages/sc_train.py
      hash: md5
      md5: 0492495176f942f33cf4a453ebaa7074
      size: 491
    params:
      params.yaml:
        base:
          basic_columns:
          - Label
          - concept_class
          - idx
          - org_groups
          - spans
          entity_static_position: false
          index_col: idx
          log_level: INFO
          main_relations:
          - supplier
          - customer
          nlp: en_core_web_trf
          random_state: 42
        sc_train:
          base_model: nlpaueb/sec-bert-base
          batch_size: 45
          classes:
          - 0
          - 1
          clip: false
          cuda: '0'
          dev_test_split: false
          epochs: 4
          features:
          - orig_sents
          learning_rate: 5e-05
          load_pretrained: false
          mutate: true
          num_workers: 0
          package_name: SupplyChainClassifier
          pipeline_name: supplychain_classification_model
          pipeline_save_file: supplychain_classification_model_output
          seed: 1
          target: Label
          train_file: data/train/train.json
          truncate: 512
          valid_file: data/train/valid.json
          wandb: false
          warmup_smooth: 0.8
          weight_decay: 0.001
    outs:
    - path: artifacts/sc_model
      hash: md5
      md5: 7fc56b13f8b182676e6cc4151ab57610.dir
      size: 437331019
      nfiles: 9
    - path: sc_metrics/sc_train_f1.csv
      hash: md5
      md5: e8e4ed4a42323ab659fffaeb878836bf
      size: 107
    - path: sc_metrics/sc_train_loss.csv
      hash: md5
      md5: 7c0c6fba80510b8916375123d82bd5fa
      size: 113
    - path: sc_metrics/sc_val_f1.csv
      hash: md5
      md5: 23b899459614b87b85111f2a3b0817d5
      size: 105
    - path: sc_metrics/sc_valid_metrics.json
      hash: md5
      md5: 5a526a0d6042feacd141215775b89e0d
      size: 164
